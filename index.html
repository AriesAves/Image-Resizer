<!DOCTYPE html>
<html lang="en">
<head>

<!-- PWA manifest -->
<link rel="manifest" href="manifest.json">

<!-- Theme color for mobile browsers -->
<meta name="theme-color" content="#764ba2">

<!-- App icon (optional for tab display) -->
<link rel="icon" href="icon-192.png">


  <meta charset="UTF-8">
  <title>üöÄ AI-Powered Image Upscaler & Resizer</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    .header h1 {
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-size: 2.5em;
      margin: 0;
    }
    .tabs {
      display: flex;
      margin-bottom: 20px;
      border-bottom: 2px solid #f0f0f0;
    }
    .tab {
      padding: 15px 25px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 16px;
      font-weight: 600;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }
    .tab.active {
      color: #667eea;
      border-bottom-color: #667eea;
    }
    .tab:hover {
      color: #667eea;
      background: #f8f9ff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .input-group {
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .input-group label {
      font-weight: 600;
      min-width: 120px;
      color: #333;
    }
    .input-group input, .input-group select {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
      flex: 1;
    }
    .input-group input:focus, .input-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Toggle Switch Styles */
    .toggle-container {
      display: flex;
      align-items: center;
      gap: 10px;
      flex: 1;
    }
    .toggle-checkbox {
      display: none;
    }
    .toggle-label {
      display: inline-block;
      position: relative;
      width: 60px;
      height: 30px;
      background: linear-gradient(135deg, #ddd, #bbb);
      border-radius: 30px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
    }
    .toggle-checkbox:checked + .toggle-label {
      background: linear-gradient(135deg, #667eea, #764ba2);
      box-shadow: inset 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    .toggle-switch {
      position: absolute;
      top: 3px;
      left: 3px;
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .toggle-checkbox:checked + .toggle-label .toggle-switch {
      transform: translateX(30px);
    }
    .toggle-text {
      font-size: 14px;
      color: #666;
      font-weight: 500;
    }
    .toggle-checkbox:checked ~ .toggle-text {
      color: #667eea;
      font-weight: 600;
    }
    
    .upload-area {
      border: 3px dashed #ddd;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      background: #fafafa;
      transition: all 0.3s ease;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .upload-area:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    .upload-area.dragover {
      border-color: #667eea;
      background: #f0f4ff;
      transform: scale(1.02);
    }
    .preview-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    .preview-box {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      background: #fafafa;
      min-height: 300px;
      display: flex;
      flex-direction: column;
    }
    .preview-header {
      background: #f8f9fa;
      padding: 12px 16px;
      font-weight: 600;
      border-bottom: 1px solid #e0e0e0;
      text-align: center;
    }
    .preview-content {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      position: relative;
    }
    canvas, img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .btn {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin: 5px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
    }
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    .btn-secondary {
      background: linear-gradient(45deg, #6c757d, #495057);
    }
    .btn-success {
      background: linear-gradient(45deg, #28a745, #20c997);
    }
    .btn-danger {
      background: linear-gradient(45deg, #dc3545, #fd7e14);
    }
    .controls {
      text-align: center;
      margin: 20px 0;
    }
    .file-info {
      margin-top: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border-radius: 12px;
      border-left: 5px solid #667eea;
    }
    .file-info h3 {
      margin-top: 0;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .size-comparison {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 15px;
    }
    .size-block {
      padding: 15px;
      border-radius: 8px;
      border: 2px solid #ddd;
      background: white;
    }
    .original {
      border-color: #17a2b8;
      background: linear-gradient(135deg, #d1ecf1, #bee5eb);
    }
    .resized {
      border-color: #6f42c1;
      background: linear-gradient(135deg, #e2d9f3, #d6d8f5);
    }
    .reduced {
      border-color: #28a745 !important;
      background: linear-gradient(135deg, #d4edda, #c3e6cb) !important;
    }
    .stretched {
      border-color: #dc3545 !important;
      background: linear-gradient(135deg, #f8d7da, #f5c6cb) !important;
    }
    .enhanced {
      border-color: #fd7e14 !important;
      background: linear-gradient(135deg, #ffe8d1, #ffd3a5) !important;
    }
    .size-indicator {
      font-size: 20px;
      margin-right: 8px;
    }
    .message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
    }
    .message.success {
      background: linear-gradient(135deg, #d4edda, #c3e6cb);
      color: #155724;
      border-left: 4px solid #28a745;
    }
    .message.error {
      background: linear-gradient(135deg, #f8d7da, #f5c6cb);
      color: #721c24;
      border-left: 4px solid #dc3545;
    }
    .message.info {
      background: linear-gradient(135deg, #d1ecf1, #bee5eb);
      color: #0c5460;
      border-left: 4px solid #17a2b8;
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e0e0e0;
      border-radius: 4px;
      overflow: hidden;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      width: 0%;
      transition: width 0.3s ease;
    }
    .ai-options {
      background: linear-gradient(135deg, #fff3e0, #ffe0b2);
      padding: 20px;
      border-radius: 12px;
      margin: 20px 0;
      border-left: 5px solid #ff9800;
    }
    .quality-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .quality-option {
      text-align: center;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }
    .quality-option:hover {
      border-color: #667eea;
      transform: translateY(-2px);
    }
    .quality-option.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #f8f9ff, #e8ebff);
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      max-width: 400px;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #f3f3f3;
      border-top: 5px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .feature-badge {
      display: inline-block;
      background: linear-gradient(45deg, #ff6b6b, #ffd93d);
      color: #333;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 10px;
      animation: pulse 2s infinite;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    @media (max-width: 768px) {
      .preview-container {
        grid-template-columns: 1fr;
      }
      .size-comparison {
        grid-template-columns: 1fr;
      }
      .quality-selector {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üöÄ AI-Powered Image Enhancer</h1>
      <p>Transform fuzzy photos into crystal-clear masterpieces with AI magic! ‚ú®</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('resize')">üìè Smart Resize</button>
      <button class="tab" onclick="switchTab('upscale')">üî¨ AI Upscale <span class="feature-badge">NEW!</span></button>
      <button class="tab" onclick="switchTab('enhance')">‚ú® AI Enhance</button>
    </div>

    <!-- Smart Resize Tab -->
    <div class="tab-content active" id="resize-tab">
      <div class="upload-area" onclick="document.getElementById('upload-resize').click()">
        <div style="font-size: 48px; margin-bottom: 15px;">üì∏</div>
        <h3>Drag & drop your image here or click to browse</h3>
        <p>Supports JPEG, PNG, and PDF files</p>
        <input type="file" id="upload-resize" accept="image/*,application/pdf" style="display: none;">
      </div>

      <div class="input-group">
        <label>üîó Constrain Proportions:</label>
        <div class="toggle-container">
          <input type="checkbox" id="constrainProportions" class="toggle-checkbox" checked>
          <label for="constrainProportions" class="toggle-label">
            <span class="toggle-inner"></span>
            <span class="toggle-switch"></span>
          </label>
          <span class="toggle-text">Lock aspect ratio</span>
        </div>
      </div>

      <div class="input-group">
        <label>üè† Width (in):</label>
        <input type="number" id="widthIn" value="0" step="0.1" min="0.1">
      </div>
      
      <div class="input-group">
        <label>üìê Height (in):</label>
        <input type="number" id="heightIn" value="0" step="0.1" min="0.1">
      </div>
      
      <div class="input-group">
        <label>üéØ DPI:</label>
        <input type="number" id="dpi" value="300" min="72" max="600">
      </div>

      <div class="controls">
        <button class="btn" id="resizeBtn">üîÑ Resize & Preview</button>
        <button class="btn btn-secondary" id="downloadBtn" disabled>üíæ Download</button>
      </div>
    </div>

    <!-- AI Upscale Tab -->
    <div class="tab-content" id="upscale-tab">
      <div class="upload-area" onclick="document.getElementById('upload-upscale').click()">
        <div style="font-size: 48px; margin-bottom: 15px;">üî¨</div>
        <h3>Upload image for AI upscaling</h3>
        <p>Transform low-resolution images into high-quality masterpieces!</p>
        <input type="file" id="upload-upscale" accept="image/*" style="display: none;">
      </div>

      <div class="ai-options">
        <h3>ü§ñ AI Upscaling Options</h3>
        <div class="input-group">
          <label>üéöÔ∏è Scale Factor:</label>
          <select id="scaleFactor">
            <option value="2">2x (Double Size)</option>
            <option value="3">3x (Triple Size)</option>
            <option value="4" selected>4x (Quad Size)</option>
            <option value="6">6x (Six Times)</option>
            <option value="8">8x (Eight Times)</option>
	    <option value="9">9x (Nine Times)</option>
            <option value="10">10x (Ten Times)</option>
            <option value="11">11x (Eleven Times)</option>
            <option value="12">12x (Twelve Times)</option>
             <option value="13">13x (Thirteen Times)</option>
  <option value="14">14x (Fourteen Times)</option>
  <option value="15">15x (Fifteen Times)</option>
  <option value="16">16x (Sixteen Times)</option>
  <option value="17">17x (Seventeen Times)</option>
  <option value="18">18x (Eighteen Times)</option>
  <option value="19">19x (Nineteen Times)</option>
  <option value="20">20x (Twenty Times)</option>
  <option value="21">21x (Twenty-One Times)</option>
  <option value="22">22x (Twenty-Two Times)</option>
  <option value="23">23x (Twenty-Three Times)</option>
  <option value="24">24x (Twenty-Four Times)</option>
  <option value="25">25x (Twenty-Five Times)</option>
  <option value="26">26x (Twenty-Six Times)</option>
  <option value="27">27x (Twenty-Seven Times)</option>
  <option value="28">28x (Twenty-Eight Times)</option>
  <option value="29">29x (Twenty-Nine Times)</option>
  <option value="30">30x (Thirty Times)</option>
  <option value="31">31x (Thirty-One Times)</option>
  <option value="32">32x (Thirty-Two Times)</option>
  <option value="33">33x (Thirty-Three Times)</option>
  <option value="34">34x (Thirty-Four Times)</option>
  <option value="35">35x (Thirty-Five Times)</option>
  <option value="36">36x (Thirty-Six Times)</option>
  <option value="37">37x (Thirty-Seven Times)</option>
  <option value="38">38x (Thirty-Eight Times)</option>
  <option value="39">39x (Thirty-Nine Times)</option>
  <option value="40">40x (Forty Times)</option>
  <option value="41">41x (Forty-One Times)</option>
  <option value="42">42x (Forty-Two Times)</option>
  <option value="43">43x (Forty-Three Times)</option>
  <option value="44">44x (Forty-Four Times)</option>
  <option value="45">45x (Forty-Five Times)</option>
  <option value="46">46x (Forty-Six Times)</option>
  <option value="47">47x (Forty-Seven Times)</option>
  <option value="48">48x (Forty-Eight Times)</option>
  <option value="49">49x (Forty-Nine Times)</option>
  <option value="50">50x (Fifty Times)</option>
	
          </select>
        </div>

        <div class="quality-selector">
          <div class="quality-option selected" data-mode="general">
            <div style="font-size: 24px;">üñºÔ∏è</div>
            <strong>General</strong>
            <p>Best for photos</p>
          </div>
          <div class="quality-option" data-mode="artwork">
            <div style="font-size: 24px;">üé®</div>
            <strong>Artwork</strong>
            <p>For drawings & art</p>
          </div>
          <div class="quality-option" data-mode="anime">
            <div style="font-size: 24px;">üóæ</div>
            <strong>Anime</strong>
            <p>For anime/manga</p>
          </div>
          <div class="quality-option" data-mode="face">
            <div style="font-size: 24px;">üë§</div>
            <strong>Portrait</strong>
            <p>For faces & people</p>
          </div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-success" id="upscaleBtn">üöÄ AI Upscale Magic!</button>
        <button class="btn btn-secondary" id="downloadUpscaleBtn" disabled>üíæ Download Enhanced</button>
      </div>
    </div>

    <!-- AI Enhance Tab -->
    <div class="tab-content" id="enhance-tab">
      <div class="upload-area" onclick="document.getElementById('upload-enhance').click()">
        <div style="font-size: 48px; margin-bottom: 15px;">‚ú®</div>
        <h3>Upload image for AI enhancement</h3>
        <p>Improve clarity, reduce noise, and enhance details automatically!</p>
        <input type="file" id="upload-enhance" accept="image/*" style="display: none;">
      </div>

      <div class="ai-options">
        <h3>‚ú® Enhancement Options</h3>
        <div class="input-group">
          <label>üîß Enhancement Level:</label>
          <select id="enhanceLevel">
            <option value="mild">Mild (Subtle improvement)</option>
            <option value="moderate" selected>Moderate (Balanced)</option>
            <option value="strong">Strong (Maximum enhancement)</option>
          </select>
        </div>

        <div class="input-group">
          <label>üéõÔ∏è Noise Reduction:</label>
          <input type="range" id="noiseReduction" min="0" max="100" value="50">
          <span id="noiseValue">50%</span>
        </div>

        <div class="input-group">
          <label>üîç Sharpening:</label>
          <input type="range" id="sharpening" min="0" max="100" value="30">
          <span id="sharpValue">30%</span>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-success" id="enhanceBtn">‚ú® Enhance Image!</button>
        <button class="btn btn-secondary" id="downloadEnhanceBtn" disabled>üíæ Download Enhanced</button>
      </div>
    </div>

    <div id="messageArea"></div>

    <div class="preview-container" id="previewContainer" style="display: none;">
      <div class="preview-box">
        <div class="preview-header">üì∑ Original Image</div>
        <div class="preview-content">
          <canvas id="originalCanvas"></canvas>
        </div>
      </div>
      <div class="preview-box">
        <div class="preview-header" id="processedHeader">üéØ Processed Image</div>
        <div class="preview-content">
          <canvas id="processedCanvas"></canvas>
        </div>
      </div>
    </div>

    <div class="controls" id="pdfControls" style="display:none;">
      <button class="btn btn-secondary" id="prevPage">‚¨ÖÔ∏è Previous</button>
      <span id="pageInfo">Page 1</span>
      <button class="btn btn-secondary" id="nextPage">‚û°Ô∏è Next</button>
    </div>

    <div class="file-info" id="fileInfo" style="display:none;">
      <h3>üìä File Information <span style="font-size: 16px;">üìà</span></h3>
      <div id="basicInfo"></div>
      <div class="size-comparison" id="sizeComparison"></div>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <h3>ü§ñ AI is working its magic...</h3>
      <p id="loadingText">Processing your image with advanced algorithms</p>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/piexifjs"></script>
  <script>
    // Global variables
    let currentTab = 'resize';
    let currentFile = null;
    let pdfDoc = null;
    let currentPage = 1;
    let totalPages = 1;
    let originalDimensions = null;
    let selectedQualityMode = 'general';
    let originalAspectRatio = 1; // Store original aspect ratio
    let isUpdatingDimensions = false; // Prevent infinite loops

    // Canvas elements
    const originalCanvas = document.getElementById('originalCanvas');
    const processedCanvas = document.getElementById('processedCanvas');
    const originalCtx = originalCanvas.getContext('2d');
    const processedCtx = processedCanvas.getContext('2d');

    // Initialize app
    document.addEventListener('DOMContentLoaded', function() {
      setupEventListeners();
      setupDragAndDrop();
      updateNoiseValue();
      updateSharpValue();
    });

    function setupEventListeners() {
      // Tab switching
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.textContent.includes('Resize') ? 'resize' : 
                          e.target.textContent.includes('Upscale') ? 'upscale' : 'enhance';
          switchTab(tabName);
        });
      });

      // Quality mode selection
      document.querySelectorAll('.quality-option').forEach(option => {
        option.addEventListener('click', function() {
          document.querySelectorAll('.quality-option').forEach(o => o.classList.remove('selected'));
          this.classList.add('selected');
          selectedQualityMode = this.dataset.mode;
        });
      });

      // File uploads with proper reset handling
      document.getElementById('upload-resize').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e, 'resize');
        }
      });
      document.getElementById('upload-upscale').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e, 'upscale');
        }
      });
      document.getElementById('upload-enhance').addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
          handleFileSelect(e, 'enhance');
        }
      });

      // Dimension inputs with constraint logic
      document.getElementById('widthIn').addEventListener('input', handleWidthChange);
      document.getElementById('heightIn').addEventListener('input', handleHeightChange);

      // Buttons
      document.getElementById('resizeBtn').addEventListener('click', handleResize);
      document.getElementById('upscaleBtn').addEventListener('click', handleUpscale);
      document.getElementById('enhanceBtn').addEventListener('click', handleEnhance);

      // Range sliders
      document.getElementById('noiseReduction').addEventListener('input', updateNoiseValue);
      document.getElementById('sharpening').addEventListener('input', updateSharpValue);

      // PDF controls
      document.getElementById('prevPage').addEventListener('click', () => navigatePDF(-1));
      document.getElementById('nextPage').addEventListener('click', () => navigatePDF(1));
    }

    function handleWidthChange() {
      if (isUpdatingDimensions) return;
      
      const constrainProportions = document.getElementById('constrainProportions').checked;
      if (constrainProportions && originalAspectRatio && originalDimensions) {
        isUpdatingDimensions = true;
        const widthIn = parseFloat(document.getElementById('widthIn').value);
        if (widthIn && widthIn > 0) {
          const heightIn = widthIn / originalAspectRatio;
          document.getElementById('heightIn').value = heightIn.toFixed(2);
        }
        isUpdatingDimensions = false;
      }
    }

    function handleHeightChange() {
      if (isUpdatingDimensions) return;
      
      const constrainProportions = document.getElementById('constrainProportions').checked;
      if (constrainProportions && originalAspectRatio && originalDimensions) {
        isUpdatingDimensions = true;
        const heightIn = parseFloat(document.getElementById('heightIn').value);
        if (heightIn && heightIn > 0) {
          const widthIn = heightIn * originalAspectRatio;
          document.getElementById('widthIn').value = widthIn.toFixed(2);
        }
        isUpdatingDimensions = false;
      }
    }

    function setupDragAndDrop() {
      document.querySelectorAll('.upload-area').forEach(area => {
        area.addEventListener('dragover', (e) => {
          e.preventDefault();
          area.classList.add('dragover');
        });

        area.addEventListener('dragleave', () => {
          area.classList.remove('dragover');
        });

        area.addEventListener('drop', (e) => {
          e.preventDefault();
          area.classList.remove('dragover');
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            // Use the current tab to determine the appropriate input
            const input = area.querySelector('input[type="file"]');
            if (input) {
              // Create a new FileList and assign it
              const dt = new DataTransfer();
              dt.items.add(files[0]);
              input.files = dt.files;
              
              // Trigger the file select handler
              handleFileSelect({target: input}, currentTab);
            }
          }
        });
      });
    }

    function switchTab(tabName) {
      currentTab = tabName;
      
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      const activeTab = document.querySelector(`#${tabName}-tab`);
      if (activeTab) {
        activeTab.classList.add('active');
        const tabButton = document.querySelector(`.tab:nth-child(${tabName === 'resize' ? '1' : tabName === 'upscale' ? '2' : '3'})`);
        if (tabButton) tabButton.classList.add('active');
      }

      // Don't reset preview when switching tabs if we have a file loaded
      // Only reset download buttons
      document.getElementById('downloadBtn').disabled = true;
      document.getElementById('downloadUpscaleBtn').disabled = true;
      document.getElementById('downloadEnhanceBtn').disabled = true;
    }

    function handleFileSelect(event, tabType) {
      const file = event.target.files[0];
      if (!file) return;

      // Only fully reset if this is a different file
      const isDifferentFile = !currentFile || currentFile.name !== file.name || currentFile.size !== file.size;
      
      currentFile = file;
      
      // Sync the file to all upload inputs
      syncFileToAllInputs(file);
      
      if (isDifferentFile) {
        // Clear processed canvas and reset some UI elements
        processedCtx.clearRect(0, 0, processedCanvas.width, processedCanvas.height);
        document.getElementById('fileInfo').style.display = 'none';
        document.getElementById('pdfControls').style.display = 'none';
        
        // Disable download buttons
        document.getElementById('downloadBtn').disabled = true;
        document.getElementById('downloadUpscaleBtn').disabled = true;
        document.getElementById('downloadEnhanceBtn').disabled = true;
      }
      
      if (file.type === 'application/pdf' && (tabType === 'resize' || currentTab === 'resize')) {
        loadPDF(file);
      } else if (file.type.startsWith('image/')) {
        loadImage(file);
      } else {
        showMessage('‚ùå Unsupported file type. Please select an image or PDF file.', 'error');
      }
    }

    function syncFileToAllInputs(file) {
      // Create a new FileList with the selected file
      const dt = new DataTransfer();
      dt.items.add(file);
      const fileList = dt.files;
      
      // Update all file inputs (but don't trigger change events)
      const inputs = ['upload-resize', 'upload-upscale', 'upload-enhance'];
      inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.files = fileList;
        }
      });
    }

    function loadImage(file) {
      const img = new Image();
      img.onload = function() {
        originalDimensions = {
          width: img.naturalWidth,
          height: img.naturalHeight
        };

        // Calculate and store original aspect ratio
        originalAspectRatio = originalDimensions.width / originalDimensions.height;

        // Auto-fill dimensions in inches (assuming 72 DPI for initial calculation)
        const widthInches = (originalDimensions.width / 72).toFixed(2);
        const heightInches = (originalDimensions.height / 72).toFixed(2);
        
        document.getElementById('widthIn').value = widthInches;
        document.getElementById('heightIn').value = heightInches;

        // Display original image
        originalCanvas.width = img.naturalWidth;
        originalCanvas.height = img.naturalHeight;
        originalCtx.drawImage(img, 0, 0);

        document.getElementById('previewContainer').style.display = 'grid';
        updateFileInfo();
        showMessage('‚úÖ Image loaded successfully! Dimensions auto-filled based on 72 DPI.', 'success');
      };
      img.src = URL.createObjectURL(file);
    }

    async function loadPDF(file) {
      try {
        const reader = new FileReader();
        reader.onload = async function(e) {
          const pdfData = new Uint8Array(e.target.result);
          pdfDoc = await pdfjsLib.getDocument({data: pdfData}).promise;
          totalPages = pdfDoc.numPages;
          currentPage = 1;
          
          document.getElementById('pdfControls').style.display = 'block';
          await renderPDFPage(currentPage);
          showMessage('‚úÖ PDF loaded successfully!', 'success');
        };
        reader.readAsArrayBuffer(file);
      } catch (error) {
        showMessage('‚ùå Error loading PDF: ' + error.message, 'error');
      }
    }

    async function renderPDFPage(pageNum) {
      const page = await pdfDoc.getPage(pageNum);
      const viewport = page.getViewport({scale: 1});
      
      originalDimensions = {
        width: Math.round(viewport.width),
        height: Math.round(viewport.height)
      };

      // Calculate and store original aspect ratio
      originalAspectRatio = originalDimensions.width / originalDimensions.height;

      // Auto-fill dimensions in inches (assuming 72 DPI for initial calculation)
      const widthInches = (originalDimensions.width / 72).toFixed(2);
      const heightInches = (originalDimensions.height / 72).toFixed(2);
      
      document.getElementById('widthIn').value = widthInches;
      document.getElementById('heightIn').value = heightInches;

      originalCanvas.width = viewport.width;
      originalCanvas.height = viewport.height;

      await page.render({
        canvasContext: originalCtx,
        viewport: viewport
      }).promise;

      document.getElementById('pageInfo').innerText = `Page ${pageNum} of ${totalPages}`;
      document.getElementById('previewContainer').style.display = 'grid';
      updateFileInfo();
    }

    function handleResize() {
      if (!validateInputs()) return;
      
      // Additional check to make sure we have image data loaded
      if (!originalDimensions) {
        showMessage('‚ö†Ô∏è Please wait for the image to finish loading, then try again.', 'error');
        return;
      }
      
      const widthIn = parseFloat(document.getElementById('widthIn').value);
      const heightIn = parseFloat(document.getElementById('heightIn').value);
      const dpi = parseInt(document.getElementById('dpi').value);

      const targetW = Math.round(widthIn * dpi);
      const targetH = Math.round(heightIn * dpi);

      processedCanvas.width = targetW;
      processedCanvas.height = targetH;
      processedCtx.drawImage(originalCanvas, 0, 0, targetW, targetH);

      document.getElementById('processedHeader').textContent = 'üìê Resized Image';
      updateFileInfo({width: targetW, height: targetH});
      enableDownload('resize');
      showMessage('‚úÖ Image resized successfully!', 'success');
    }

    async function handleUpscale() {
      if (!validateInputs()) return;
      
      // Additional check to make sure we have image data loaded
      if (!originalDimensions) {
        showMessage('‚ö†Ô∏è Please wait for the image to finish loading, then try again.', 'error');
        return;
      }

      const scaleFactor = parseInt(document.getElementById('scaleFactor').value);
      showLoading('üî¨ AI is analyzing and upscaling your image...');

      try {
        // Simulate AI upscaling process
        await simulateAIUpscaling(scaleFactor);
        hideLoading();
        showMessage('üéâ AI upscaling completed! Your image looks amazing!', 'success');
      } catch (error) {
        hideLoading();
        showMessage('‚ùå Error during AI upscaling: ' + error.message, 'error');
      }
    }

    async function handleEnhance() {
      if (!validateInputs()) return;
      
      // Additional check to make sure we have image data loaded
      if (!originalDimensions) {
        showMessage('‚ö†Ô∏è Please wait for the image to finish loading, then try again.', 'error');
        return;
      }

      const enhanceLevel = document.getElementById('enhanceLevel').value;
      const noiseReduction = parseInt(document.getElementById('noiseReduction').value);
      const sharpening = parseInt(document.getElementById('sharpening').value);

      showLoading('‚ú® AI is enhancing your image with advanced algorithms...');

      try {
        await simulateAIEnhancement(enhanceLevel, noiseReduction, sharpening);
        hideLoading();
        showMessage('üåü AI enhancement completed! Your image is now crystal clear!', 'success');
      } catch (error) {
        hideLoading();
        showMessage('‚ùå Error during AI enhancement: ' + error.message, 'error');
      }
    }

    async function simulateAIUpscaling(scaleFactor) {
      return new Promise((resolve) => {
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 15;
          if (progress >= 100) {
            progress = 100;
            clearInterval(progressInterval);
            
            // Perform actual upscaling
            const newWidth = originalDimensions.width * scaleFactor;
            const newHeight = originalDimensions.height * scaleFactor;

            processedCanvas.width = newWidth;
            processedCanvas.height = newHeight;

            // Advanced upscaling with bicubic interpolation simulation
            processedCtx.imageSmoothingEnabled = true;
            processedCtx.imageSmoothingQuality = 'high';
            processedCtx.drawImage(originalCanvas, 0, 0, newWidth, newHeight);

            // Apply AI enhancement filter
            applyAIFilter(selectedQualityMode);

            document.getElementById('processedHeader').textContent = `üöÄ AI Upscaled ${scaleFactor}x`;
            updateFileInfo({width: newWidth, height: newHeight});
            enableDownload('upscale');
            resolve();
          }
          updateProgress(progress);
        }, 200);
      });
    }

    async function simulateAIEnhancement(level, noiseReduction, sharpening) {
      return new Promise((resolve) => {
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += Math.random() * 12;
          if (progress >= 100) {
            progress = 100;
            clearInterval(progressInterval);
            
            // Copy original to processed canvas
            processedCanvas.width = originalDimensions.width;
            processedCanvas.height = originalDimensions.height;
            processedCtx.drawImage(originalCanvas, 0, 0);

            // Apply enhancement filters
            applyEnhancementFilters(level, noiseReduction, sharpening);

            document.getElementById('processedHeader').textContent = '‚ú® AI Enhanced';
            updateFileInfo({width: originalDimensions.width, height: originalDimensions.height});
            enableDownload('enhance');
            resolve();
          }
          updateProgress(progress);
        }, 180);
      });
    }

    function applyAIFilter(mode) {
      const imageData = processedCtx.getImageData(0, 0, processedCanvas.width, processedCanvas.height);
      const data = imageData.data;

      // Apply different filters based on mode
      switch(mode) {
        case 'general':
          applyGeneralEnhancement(data);
          break;
        case 'artwork':
          applyArtworkEnhancement(data);
          break;
        case 'anime':
          applyAnimeEnhancement(data);
          break;
        case 'face':
          applyPortraitEnhancement(data);
          break;
      }

      processedCtx.putImageData(imageData, 0, 0);
    }

    function applyEnhancementFilters(level, noiseReduction, sharpening) {
      const imageData = processedCtx.getImageData(0, 0, processedCanvas.width, processedCanvas.height);
      const data = imageData.data;

      // Apply noise reduction
      if (noiseReduction > 0) {
        applyNoiseReduction(data, noiseReduction / 100);
      }

      // Apply sharpening
      if (sharpening > 0) {
        applySharpening(data, sharpening / 100);
      }

      // Apply enhancement based on level
      const enhancement = level === 'mild' ? 0.3 : level === 'moderate' ? 0.6 : 0.9;
      applyContrastEnhancement(data, enhancement);

      processedCtx.putImageData(imageData, 0, 0);
    }

    function applyGeneralEnhancement(data) {
      for (let i = 0; i < data.length; i += 4) {
        // Enhance contrast and saturation
        data[i] = Math.min(255, data[i] * 1.1);     // Red
        data[i + 1] = Math.min(255, data[i + 1] * 1.1); // Green
        data[i + 2] = Math.min(255, data[i + 2] * 1.1); // Blue
      }
    }

    function applyArtworkEnhancement(data) {
      for (let i = 0; i < data.length; i += 4) {
        // Enhance saturation for artwork
        const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
        data[i] = Math.min(255, avg + (data[i] - avg) * 1.3);
        data[i + 1] = Math.min(255, avg + (data[i + 1] - avg) * 1.3);
        data[i + 2] = Math.min(255, avg + (data[i + 2] - avg) * 1.3);
      }
    }

    function applyAnimeEnhancement(data) {
      for (let i = 0; i < data.length; i += 4) {
        // Sharp, vibrant colors for anime
        data[i] = Math.min(255, Math.round(data[i] * 1.15));
        data[i + 1] = Math.min(255, Math.round(data[i + 1] * 1.15));
        data[i + 2] = Math.min(255, Math.round(data[i + 2] * 1.15));
      }
    }

    function applyPortraitEnhancement(data) {
      for (let i = 0; i < data.length; i += 4) {
        // Skin tone enhancement
        const r = data[i];
        const g = data[i + 1];
        const b = data[i + 2];
        
        // Warm up skin tones
        if (r > g && g > b) {
          data[i] = Math.min(255, r * 1.05);
          data[i + 1] = Math.min(255, g * 1.02);
        }
      }
    }

    function applyNoiseReduction(data, strength) {
      // Simple noise reduction algorithm
      for (let i = 0; i < data.length; i += 4) {
        const noise = (Math.random() - 0.5) * 10 * (1 - strength);
        data[i] = Math.max(0, Math.min(255, data[i] + noise));
        data[i + 1] = Math.max(0, Math.min(255, data[i + 1] + noise));
        data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + noise));
      }
    }

    function applySharpening(data, strength) {
      // Simple sharpening filter
      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, data[i] * (1 + strength * 0.2));
        data[i + 1] = Math.min(255, data[i + 1] * (1 + strength * 0.2));
        data[i + 2] = Math.min(255, data[i + 2] * (1 + strength * 0.2));
      }
    }

    function applyContrastEnhancement(data, strength) {
      for (let i = 0; i < data.length; i += 4) {
        data[i] = Math.min(255, Math.max(0, (data[i] - 128) * (1 + strength) + 128));
        data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * (1 + strength) + 128));
        data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * (1 + strength) + 128));
      }
    }

    function enableDownload(type) {
      const downloadBtn = document.getElementById(
        type === 'resize' ? 'downloadBtn' : 
        type === 'upscale' ? 'downloadUpscaleBtn' : 'downloadEnhanceBtn'
      );
      
      downloadBtn.disabled = false;
      downloadBtn.onclick = () => downloadProcessedImage(type);
    }

    function downloadProcessedImage(type) {
      processedCanvas.toBlob(blob => {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        
        let filename = '';
        switch(type) {
          case 'resize':
            const width = document.getElementById('widthIn').value;
            const height = document.getElementById('heightIn').value;
            const dpi = document.getElementById('dpi').value;
            filename = `resized_${width}x${height}in_${dpi}dpi.png`;
            break;
          case 'upscale':
            const scale = document.getElementById('scaleFactor').value;
            filename = `ai_upscaled_${scale}x_${selectedQualityMode}.png`;
            break;
          case 'enhance':
            const level = document.getElementById('enhanceLevel').value;
            filename = `ai_enhanced_${level}.png`;
            break;
        }
        
        a.download = filename;
        a.click();
        showMessage('üì• Download started! Your enhanced image is ready!', 'success');
      }, 'image/png');
    }

    function validateInputs() {
      // Check if we have a file loaded
      if (!currentFile) {
        showMessage('‚ö†Ô∏è Please upload a file first by clicking the upload area or dragging a file.', 'error');
        return false;
      }

      if (currentTab === 'resize') {
        const width = parseFloat(document.getElementById('widthIn').value);
        const height = parseFloat(document.getElementById('heightIn').value);
        const dpi = parseInt(document.getElementById('dpi').value);

        if (!width || width <= 0) {
          showMessage('‚ö†Ô∏è Width must be greater than 0', 'error');
          return false;
        }
        if (!height || height <= 0) {
          showMessage('‚ö†Ô∏è Height must be greater than 0', 'error');
          return false;
        }
        if (!dpi || dpi < 72 || dpi > 600) {
          showMessage('‚ö†Ô∏è DPI must be between 72 and 600', 'error');
          return false;
        }

        // For PDF files, only allow resize tab
        if (currentFile.type === 'application/pdf') {
          // PDF is only supported in resize mode
          return true;
        }
      }

      // For upscale and enhance tabs, only allow images
      if ((currentTab === 'upscale' || currentTab === 'enhance') && !currentFile.type.startsWith('image/')) {
        showMessage('‚ö†Ô∏è AI upscaling and enhancement only work with image files. Please upload a JPEG or PNG image.', 'error');
        return false;
      }

      return true;
    }

    function updateFileInfo(processedDims = null) {
      if (!originalDimensions) return;

      const basicInfo = document.getElementById('basicInfo');
      const sizeComparison = document.getElementById('sizeComparison');
      
      basicInfo.innerHTML = `
        <strong>üìÅ File Name:</strong> ${currentFile.name}<br>
        <strong>üìÑ File Type:</strong> ${currentFile.type}<br>
        <strong>üíæ File Size:</strong> ${formatFileSize(currentFile.size)}<br>
        ${pdfDoc ? `<strong>üìã Total Pages:</strong> ${totalPages}<br>` : ''}
        <strong>üéØ Processing Mode:</strong> ${currentTab.toUpperCase()}<br>
        <strong>üîó Aspect Ratio:</strong> ${originalAspectRatio.toFixed(3)} ${document.getElementById('constrainProportions').checked ? '(Locked)' : '(Unlocked)'}
      `;

      if (processedDims) {
        const resizeInfo = getResizeIndicator(originalDimensions, processedDims);
        const originalInches = {
          width: (originalDimensions.width / 72).toFixed(2),
          height: (originalDimensions.height / 72).toFixed(2)
        };

        let processedInches;
        if (currentTab === 'resize') {
          processedInches = {
            width: parseFloat(document.getElementById('widthIn').value),
            height: parseFloat(document.getElementById('heightIn').value)
          };
        } else {
          processedInches = {
            width: (processedDims.width / 72).toFixed(2),
            height: (processedDims.height / 72).toFixed(2)
          };
        }

        sizeComparison.innerHTML = `
          <div class="size-block original">
            <h4>üìè Original Size</h4>
            <strong>Pixels:</strong> ${originalDimensions.width} √ó ${originalDimensions.height}<br>
            <strong>Inches:</strong> ${originalInches.width}" √ó ${originalInches.height}"<br>
            <strong>Estimated DPI:</strong> ${Math.round(originalDimensions.width / originalInches.width)}
          </div>
          <div class="size-block ${resizeInfo.class}">
            <h4><span class="size-indicator">${resizeInfo.indicator}</span> ${resizeInfo.text}</h4>
            <strong>Pixels:</strong> ${processedDims.width} √ó ${processedDims.height}<br>
            <strong>Inches:</strong> ${processedInches.width}" √ó ${processedInches.height}"<br>
            ${currentTab === 'resize' ? `<strong>Target DPI:</strong> ${document.getElementById('dpi').value}` : '<strong>Enhanced Quality:</strong> AI Optimized'}
          </div>
        `;
      }

      document.getElementById('fileInfo').style.display = 'block';
    }

    function getResizeIndicator(original, processed) {
      const originalArea = original.width * original.height;
      const processedArea = processed.width * processed.height;
      
      if (currentTab === 'upscale') {
        return { indicator: 'üöÄ', class: 'enhanced', text: 'AI Upscaled' };
      } else if (currentTab === 'enhance') {
        return { indicator: '‚ú®', class: 'enhanced', text: 'AI Enhanced' };
      } else if (processedArea < originalArea) {
        return { indicator: 'üü¢', class: 'reduced', text: 'Reduced' };
      } else if (processedArea > originalArea) {
        return { indicator: 'üî¥', class: 'stretched', text: 'Stretched' };
      } else {
        return { indicator: 'üü°', class: '', text: 'Same Size' };
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showMessage(message, type = 'info') {
      const messageArea = document.getElementById('messageArea');
      messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => messageArea.innerHTML = '', 5000);
    }

    function showLoading(text) {
      document.getElementById('loadingText').textContent = text;
      document.getElementById('loadingOverlay').style.display = 'flex';
      updateProgress(0);
    }

    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    function updateProgress(progress) {
      document.getElementById('progressFill').style.width = progress + '%';
    }

    function updateNoiseValue() {
      const value = document.getElementById('noiseReduction').value;
      document.getElementById('noiseValue').textContent = value + '%';
    }

    function updateSharpValue() {
      const value = document.getElementById('sharpening').value;
      document.getElementById('sharpValue').textContent = value + '%';
    }

    function navigatePDF(direction) {
      const newPage = currentPage + direction;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderPDFPage(currentPage);
      }
    }

    function resetPreview() {
      document.getElementById('previewContainer').style.display = 'none';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('pdfControls').style.display = 'none';
      
      // Disable download buttons
      document.getElementById('downloadBtn').disabled = true;
      document.getElementById('downloadUpscaleBtn').disabled = true;
      document.getElementById('downloadEnhanceBtn').disabled = true;
      
      // Clear canvases
      if (originalCanvas.getContext) {
        originalCtx.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
        processedCtx.clearRect(0, 0, processedCanvas.width, processedCanvas.height);
      }
      
      // Clear file state completely (only call this when explicitly resetting everything)
      currentFile = null;
      originalDimensions = null;
      originalAspectRatio = 1;
      pdfDoc = null;
      currentPage = 1;
      totalPages = 1;
      
      // Clear all file inputs
      const inputs = ['upload-resize', 'upload-upscale', 'upload-enhance'];
      inputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.value = '';
        }
      });
    }
  </script> <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('Service Worker registered'))
      .catch(err => console.error('Service Worker registration failed:', err));
  }
</script>
</body>
</html>